<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pay-Per-Request Gateway</title>
  <link rel="icon" href="/assets/logo.png" />
  <style>
    :root{
      --accent:#5d3e84;
      --accent-2:#412a61;
      --bg:#ffffff;
      --text:#111213;
      --sub:#6b7280;
      --ring:rgba(93,62,132,.25);
      --muted:#f3f4f6;
      --border:#ececf0;
      --ok:#12b886;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--accent);text-decoration:none}
    .container{max-width:1120px;margin:0 auto;padding:0 20px}

    /* Header */
    .header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:30}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:28px}
    .brand h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .actions{display:flex;align-items:center;gap:10px}
    .pill{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .pill:hover{border-color:#ddd}
    .btn{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
      box-shadow:0 8px 20px var(--ring);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Hero */
    .hero{padding:42px 0 22px}
    .h-title{font-size:30px;line-height:1.15;margin:0 0 8px}
    .h-sub{color:var(--sub);max-width:760px;margin:0}

    /* Panels */
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;margin:28px 0}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--border);border-radius:16px;background:#fff;
      box-shadow:0 12px 36px rgba(17,17,17,.05);
    }
    .card .hd{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .card .bd{padding:18px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    input,select{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;
      outline:none
    }
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--ring)}
    .muted{color:var(--sub)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;
      background:#f5f3f9;color:#3c2c58;border:1px solid #ece7f6}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#9aa0aa}
    .status-ok{background:var(--ok)} .status-bad{background:var(--bad)}

    .console{background:#0b0c10;color:#e8f5ff;border-radius:12px;padding:12px;min-height:120px;white-space:pre-wrap;word-break:break-word}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;padding:3px 6px;border-radius:6px;background:#eef2ff;border:1px solid #dbe3ff}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;z-index:50}
    .modal{width:min(720px,96vw);background:#fff;border-radius:16px;box-shadow:0 30px 90px rgba(0,0,0,.35);overflow:hidden}
    .modal .hd{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .modal .title{margin:0;font-size:18px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin:8px 0}
    .log{background:#0c0d12;color:#d0ffd8;border-radius:12px;padding:12px;min-height:90px;white-space:pre-wrap}
    .tagsm{display:inline-block;background:#f1ecf8;color:#3b2b52;border-radius:999px;padding:2px 10px;font-weight:700}

    /* Footer */
    .ft{padding:22px 0;border-top:1px solid var(--border);text-align:center;color:#9095a1}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="container">
      <div class="nav">
        <div class="brand">
          <img src="/assets/logo.png" alt="Logo" />
          <h1>Pay-Per-Request Gateway</h1>
        </div>
        <div class="actions">
          <button class="pill" id="openSettings">Settings</button>
          <a class="pill" href="/health" target="_blank" rel="noopener">Health</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Hero -->
  <div class="container hero">
    <h2 class="h-title">Charge per request. Deliver value after payment.</h2>
    <p class="h-sub">This gateway responds with <span class="kbd">HTTP 402</span> and payment metadata. After a valid USDC transfer on Base, the request is redeemed and the premium payload is returned.</p>
  </div>

  <!-- Main -->
  <div class="container grid">
    <!-- Left: Action -->
    <section class="card">
      <div class="hd">
        <strong>Protected Endpoint</strong>
        <span class="badge"><span class="status-dot" id="liveDot"></span> <span id="liveText">Idle</span></span>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label class="muted">API Base URL</label>
            <input id="apiBase" />
          </div>
          <div style="max-width:260px">
            <label class="muted">Endpoint</label>
            <select id="endpoint">
              <option value="/v1/alpha-signal">/v1/alpha-signal</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button class="btn" id="btnRequest">Request Data</button>
          <button class="pill" id="btnClear">Clear Console</button>
        </div>

        <div class="console" id="console" style="margin-top:14px">Ready.</div>
      </div>
    </section>

    <!-- Right: Summary -->
    <section class="card">
      <div class="hd">
        <strong>How it Works</strong>
      </div>
      <div class="bd">
        <ol style="margin:0 0 12px 18px;line-height:1.65">
          <li>You call a protected endpoint.</li>
          <li>Server answers with <b>HTTP 402</b> + price, token, chain, nonce, expiry.</li>
          <li>A payment modal asks for USDC on Base to your merchant address.</li>
          <li>Client sends <span class="kbd">txHash</span> + <span class="kbd">nonce</span> to <span class="kbd">/redeem</span>.</li>
          <li>Server verifies transfer → returns the premium payload.</li>
        </ol>
        <div class="muted" style="margin-top:10px">
          Network: <b>Base</b> • Token: <b>USDC</b> • You need a small amount of <b>ETH</b> for gas.
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="hd">
        <h3 class="title">Payment Required</h3>
        <button class="pill" id="closeModal">Close</button>
      </div>
      <div class="bd" style="padding:18px 20px">
        <div class="kv"><div>Price</div><div><span id="mPrice" class="tagsm">-</span></div></div>
        <div class="kv"><div>Token</div><div>USDC</div></div>
        <div class="kv"><div>Chain</div><div>Base</div></div>
        <div class="kv"><div>To</div><div id="mTo" class="muted">-</div></div>
        <div class="kv"><div>Nonce</div><div id="mNonce" class="muted">-</div></div>
        <div class="kv"><div>Expiry</div><div id="mExp" class="muted">-</div></div>

        <div class="row" style="margin-top:14px">
          <button class="btn" id="btnPay">Pay with MetaMask</button>
          <button class="pill" id="btnCancel">Cancel</button>
        </div>

        <div class="log" id="mLog" style="margin-top:14px">Ready.</div>
      </div>
    </div>
  </div>

  <div class="ft">© tnemyap</div>

  <!-- App -->
  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js";

    const $ = (id)=>document.getElementById(id);
    const c = $("console");
    const log = (s)=>{ c.textContent=(c.textContent?c.textContent+"\\n":"")+s; c.scrollTop=c.scrollHeight; };
    const mlog = (s)=>{ const el=$("mLog"); el.textContent=(el.textContent?el.textContent+"\\n":"")+s; el.scrollTop=el.scrollHeight; };

    // Default API base = current origin
    $("apiBase").value = window.location.origin;

    // Status badge helpers
    const liveDot = $("liveDot");
    const liveText = $("liveText");
    const setBusy = (b)=>{ liveDot.classList.toggle("status-ok", !b); liveDot.classList.toggle("status-bad", false); liveText.textContent=b?"Working…":"Idle"; };
    const setError = ()=>{ liveDot.classList.add("status-bad"); liveText.textContent="Error"; };

    // Modal helpers
    const showModal = ()=>($("backdrop").style.display="grid");
    const hideModal = ()=>($("backdrop").style.display="none");

    // Constants
    const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const ERC20_ABI = ["function transfer(address to,uint256 amount) returns (bool)","function balanceOf(address) view returns (uint256)"];

    let lastHeaders = null;
    let paying = false;

    // Settings quick toggle (for base URL only)
    $("openSettings").onclick = ()=>{
      const f = prompt("API Base URL", $("apiBase").value);
      if (f) $("apiBase").value = f.trim();
    };

    $("btnClear").onclick = ()=>{ c.textContent=""; };

    // Request protected endpoint → may return 402 with headers
    $("btnRequest").onclick = async ()=>{
      setBusy(true);
      try{
        const base = $("apiBase").value;
        const ep = $("endpoint").value;
        const res = await fetch(new URL(ep, base), { method:"GET" });
        const txt = await res.text();
        log(`Request ${res.status}: ${txt}`);

        if(res.status===402){
          lastHeaders = res.headers;
          $("mPrice").textContent = res.headers.get("X-402-Amount") || "-";
          $("mTo").textContent    = res.headers.get("X-402-To")     || "-";
          $("mNonce").textContent = res.headers.get("X-402-Nonce")  || "-";
          const exp = res.headers.get("X-402-Expires-At");
          $("mExp").textContent   = exp ? new Date(Number(exp)).toLocaleString() : "-";
          $("mLog").textContent   = "Ready.";
          showModal();
        }
      }catch(e){
        setError();
        log("Error: "+(e.message||e));
      }finally{
        setBusy(false);
      }
    };

    $("btnCancel").onclick = hideModal;
    $("closeModal").onclick = hideModal;

    $("btnPay").onclick = async ()=>{
      if(paying) return;
      paying = true; $("btnPay").disabled = true;

      try{
        if(!window.ethereum) throw new Error("MetaMask not detected.");
        mlog("Connecting wallet…");
        const accts = await ethereum.request({ method:"eth_requestAccounts" });
        const addr = accts[0];
        mlog("Wallet: "+addr);

        // Ensure Base
        const baseId = "0x2105";
        const curId = await ethereum.request({ method:"eth_chainId" });
        if(curId !== baseId){
          try{
            await ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: baseId }] });
          }catch(err){
            if(err.code===4902){
              await ethereum.request({
                method:"wallet_addEthereumChain",
                params:[{ chainId: baseId, chainName:"Base", nativeCurrency:{ name:"ETH", symbol:"ETH", decimals:18 },
                          rpcUrls:["https://mainnet.base.org"], blockExplorerUrls:["https://basescan.org"] }]
              });
            }else{ throw err; }
          }
        }

        const to    = lastHeaders.get("X-402-To");
        const amtH  = lastHeaders.get("X-402-Amount");
        const nonce = lastHeaders.get("X-402-Nonce");
        if(!to || !amtH || !nonce) throw new Error("Missing 402 headers.");

        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const usdc = new ethers.Contract(USDC, ERC20_ABI, signer);

        // Pre-check balance for friendlier UX
        const bal6 = await usdc.balanceOf(addr);
        const need6 = ethers.parseUnits(amtH, 6);
        if (bal6 < need6){
          mlog(`❌ Insufficient USDC. Need ${amtH}, you have ${ethers.formatUnits(bal6,6)}.`);
          paying=false; $("btnPay").disabled = false; return;
        }

        mlog(`Sending USDC ${amtH} to ${to}…`);
        const tx = await usdc.transfer(to, need6);
        mlog("Pending tx: "+tx.hash);
        const rc = await tx.wait();
        mlog("Confirmed in block "+rc.blockNumber);

        // Redeem
        const redeem = `/v1/alpha-signal/redeem?nonce=${encodeURIComponent(nonce)}&tx=${tx.hash}`;
        const rr = await fetch(new URL(redeem, $("apiBase").value));
        const data = await rr.json();
        mlog("Redeem response: "+JSON.stringify(data,null,2));
        if(rr.ok){
          hideModal();
          log("✅ Payload: "+JSON.stringify(data));
        }else{
          log("❌ Redeem failed: "+(data.error||rr.status));
        }
      }catch(e){
        if(e.code===-32002) mlog("❌ MetaMask request already pending. Close the existing pop-up and try again.");
        else if(String(e).includes("exceeds balance")) mlog("❌ Transfer failed: USDC balance is not sufficient.");
        else mlog("❌ "+(e.shortMessage||e.message||e));
      }finally{
        paying=false; $("btnPay").disabled = false;
      }
    };
  </script>
</body>
</html>
