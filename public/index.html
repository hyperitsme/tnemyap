<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HTTP 402 Pay-Per-Request</title>
  <link rel="icon" href="/assets/logo.png" />
  <style>
    :root { --accent:#5d3e84; --bg:#fff; --text:#141414; --muted:#666; }
    * { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; gap:12px; padding:20px; border-bottom:1px solid #eee; }
    header img { height:28px; }
    h1 { margin:0; font-size:22px; letter-spacing:.2px; }
    main { max-width:980px; margin:32px auto; padding:0 16px; }
    .card { border:1px solid #eee; border-radius:14px; padding:20px; box-shadow:0 6px 24px rgba(0,0,0,.04); background:#fff; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .btn { background:var(--accent); color:#fff; border:none; border-radius:10px; padding:12px 16px; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .pill { border:1px solid #ddd; padding:10px 12px; border-radius:10px; background:#fff; cursor:pointer; }
    input, select { padding:10px 12px; border:1px solid #e5e5e5; border-radius:10px; width:100%; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .muted { color:var(--muted); }
    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; place-items:center; }
    .modal { width:min(660px,92vw); background:#fff; border-radius:14px; box-shadow:0 24px 70px rgba(0,0,0,.25); }
    .modal header { border-bottom:1px solid #eee; }
    .modal .body { padding:20px; }
    .kv { display:grid; grid-template-columns:140px 1fr; gap:10px; margin:6px 0; }
    .tag { display:inline-block; padding:2px 8px; background:#f4f1f8; color:#3b2b52; border-radius:999px; font-weight:600; }
    .logs { background:#0b0b0b; color:#d1ffd1; border-radius:10px; padding:10px; min-height:80px; white-space:pre-wrap; }
    footer { text-align:center; padding:24px; color:#888; }
  </style>
</head>
<body>
  <header>
    <img src="/assets/logo.png" alt="logo" />
    <h1>HTTP <span style="color:var(--accent)">402</span> Pay-Per-Request Engine</h1>
  </header>

  <main class="row">
    <section class="card" style="flex:1 1 360px;">
      <h3>Quick Test</h3>
      <div class="row">
        <div style="flex:1 1 380px;">
          <label class="muted">API Base URL</label>
          <input id="apiBase" />
        </div>
        <div style="width:220px;">
          <label class="muted">Endpoint</label>
          <select id="endpoint">
            <option value="/v1/alpha-signal">/v1/alpha-signal</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px;" class="row">
        <button class="btn" id="btnProtected">Call Protected</button>
        <button class="pill" id="btnHealth">Health</button>
        <span id="stateDot" class="muted">• Idle</span>
      </div>
      <div style="margin-top:12px;" class="logs" id="console">Ready.</div>
    </section>

    <section class="card" style="flex:1 1 360px;">
      <h3>How it works</h3>
      <ol>
        <li>Call protected endpoint → server balas <strong>HTTP 402</strong> + header harga</li>
        <li>UI membuka modal pembayaran</li>
        <li>User bayar <b>USDC</b> di <b>Base</b> ke merchant</li>
        <li>UI kirim <code>txHash</code> + <code>nonce</code> ke <code>/redeem</code></li>
        <li>Server verifikasi tx → kirim data berbayar</li>
      </ol>
      <p class="muted">Pastikan MetaMask ada jaringan <b>Base</b> & punya USDC.</p>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <header>
        <h3 style="margin:0 20px;">Payment Required</h3>
      </header>
      <div class="body">
        <div class="kv"><div>Price</div><div><span id="mPrice" class="tag">-</span></div></div>
        <div class="kv"><div>Token</div><div>USDC</div></div>
        <div class="kv"><div>Chain</div><div>Base</div></div>
        <div class="kv"><div>To</div><div id="mTo" class="muted">-</div></div>
        <div class="kv"><div>Nonce</div><div id="mNonce" class="muted">-</div></div>
        <div class="kv"><div>Expiry</div><div id="mExp" class="muted">-</div></div>

        <div class="row" style="margin-top:14px;">
          <button class="btn" id="btnPay">Pay with MetaMask</button>
          <button class="pill" id="btnCancel">Cancel</button>
        </div>

        <div style="margin-top:12px;" class="logs" id="mLog">Ready.</div>
      </div>
    </div>
  </div>

  <footer>© tnemyap</footer>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js";

    // ==== Helpers ====
    const log = (s) => { const c=document.getElementById('console'); c.textContent = (c.textContent?c.textContent+"\n":"")+s; c.scrollTop=c.scrollHeight; };
    const mlog = (s) => { const c=document.getElementById('mLog'); c.textContent = (c.textContent?c.textContent+"\n":"")+s; c.scrollTop=c.scrollHeight; };
    const $ = (id) => document.getElementById(id);

    // Default Base URL = origin
    const apiBase = $("apiBase");
    apiBase.value = window.location.origin;

    // Modal
    const modal = $("modal");
    const showModal = () => (modal.style.display="grid");
    const hideModal = () => (modal.style.display="none");

    const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const ERC20_ABI = ["function transfer(address to,uint256 amount) returns (bool)"];

    let lastHeaders = null;

    async function call(path) {
      const res = await fetch(new URL(path, apiBase.value), { method:"GET" });
      return res;
    }

    $("btnHealth").onclick = async () => {
      $("stateDot").textContent = "• Loading…";
      try {
        const r = await call("/health");
        const t = await r.text();
        log(`Health ${r.status}: ${t}`);
      } catch (e) {
        log("Health error: "+e);
      } finally {
        $("stateDot").textContent = "• Idle";
      }
    };

    $("btnProtected").onclick = async () => {
      $("stateDot").textContent = "• Loading…";
      try {
        const r = await call($("endpoint").value);
        const text = await r.text();
        log(`Protected ${r.status}: ${text}`);
        if (r.status === 402) {
          lastHeaders = r.headers;
          // isi modal
          $("mPrice").textContent = r.headers.get("X-402-Amount") || "-";
          $("mTo").textContent    = r.headers.get("X-402-To") || "-";
          $("mNonce").textContent = r.headers.get("X-402-Nonce") || "-";
          const exp = r.headers.get("X-402-Expires-At");
          $("mExp").textContent   = exp ? new Date(Number(exp)).toLocaleString() : "-";
          $("mLog").textContent   = "Ready.";
          showModal();
        }
      } catch (e) {
        log("Error: "+e);
      } finally {
        $("stateDot").textContent = "• Idle";
      }
    };

    $("btnCancel").onclick = hideModal;

    let paying = false;
    $("btnPay").onclick = async () => {
      if (paying) return;
      paying = true;
      $("btnPay").disabled = true;
      try {
        if (!window.ethereum) throw new Error("MetaMask not found");
        mlog("Requesting wallet…");
        const accts = await ethereum.request({ method:"eth_requestAccounts" });
        mlog("Wallet: "+accts[0]);

        // Switch ke Base
        const base = "0x2105";
        const cur = await ethereum.request({ method:"eth_chainId" });
        if (cur !== base) {
          try {
            await ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: base }] });
          } catch (err) {
            if (err.code === 4902) {
              await ethereum.request({
                method: "wallet_addEthereumChain",
                params: [{
                  chainId: base,
                  chainName: "Base",
                  nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
                  rpcUrls: ["https://mainnet.base.org"],
                  blockExplorerUrls: ["https://basescan.org"]
                }]
              });
            } else { throw err; }
          }
        }

        const to    = lastHeaders.get("X-402-To");
        const amt   = lastHeaders.get("X-402-Amount");
        const nonce = lastHeaders.get("X-402-Nonce");
        if (!to || !amt || !nonce) throw new Error("Incomplete 402 headers");

        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const usdc = new ethers.Contract(USDC, ERC20_ABI, signer);
        const amount6 = ethers.parseUnits(amt, 6);

        mlog(`Sending USDC ${amt} to ${to}…`);
        const tx = await usdc.transfer(to, amount6);
        mlog("Pending tx: "+tx.hash);
        const rc = await tx.wait();
        mlog("Confirmed in block "+rc.blockNumber);

        // REDEEM
        mlog("Redeeming…");
        const redeemUrl = `/v1/alpha-signal/redeem?nonce=${encodeURIComponent(nonce)}&tx=${tx.hash}`;
        const rr = await fetch(new URL(redeemUrl, apiBase.value));
        const data = await rr.json();
        mlog("Redeem response: "+JSON.stringify(data, null, 2));
        if (rr.ok) {
          alert("✅ Paid & redeemed! Check console area.");
          hideModal();
        } else {
          alert("Redeem failed: "+(data.error||rr.status));
        }
      } catch (e) {
        if (e.code === -32002) {
          mlog("❌ MetaMask request already pending. Close existing pop-up and try again.");
        } else {
          mlog("❌ "+(e.message || e));
        }
      } finally {
        paying = false;
        $("btnPay").disabled = false;
      }
    };
  </script>
</body>
</html>
